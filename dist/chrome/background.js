(()=>{var e={167:(e,t,r)=>{"use strict";r.d(t,{RV:()=>re,P_:()=>ce,bG:()=>ge,F:()=>de});var n=r(63);class s{constructor(e,t){this.masterTabId=e,this.page=t}}var a=r(559);const o=Object.freeze({INIT:"init",THREADS:"threads",HIDE_THREAD:"hideThread",UNHIDE_THREAD:"unHideThread",SEND_THREADS_TO_ANOTHER_TAB:"sendThreadsToAnotherTab",AM_I_SPAWNED:"amISpawned",FETCH_THREADS_FROM_OTHER_PAGES:"fetchThreadsFromOtherPages",REQUEST_CACHED_THREADS:"requestCachedThreads",ASK_FOR_MESSAGES:"askForMessages",CLEAR_STORE:"clearStore",GET_SYNC_ID:"getSyncId",ADD_TAG:"addTag",ACQUIRE_SYNC_ID:"acquireSyncId",PAIR_DEVICE:"pairDevice",START_SYNC:"startSync",RESET_DB:"resetDb"}),i=Object.freeze({INIT_COMPLETE:"initComplete",INIT_FAILED:"initFailed",UNKNOWN_MESSAGE:"unknownMessage",FAILED_THREAD:"failedThread",WHITELISTED_THREAD:"whitelistedThread",IMAGE_SCAN_START:"imageScanStart",IMAGE_SCAN_FINISHED:"imageScanFinished",IMAGE_SCAN_OVER:"imageScanOver",YOU_A_SPAWN_BRO:"youASpawnBro",NAH_YOU_LEGIT_BRO:"nahYouLegitBro",THREAD_FROM_OTHER_PAGE:"threadFromOtherPage",UNREAD_MESSAGE:"unreadMessage",NEW_SYNC_ID:"newSyncId",PAIR_RESULT:"pairResult",SYNC_LOG:"syncLog"}),c="alreadyInDb",l="whitelisted";var g=r(751),A=r(415);function m(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,s,a=[],o=!0,i=!1;try{for(r=r.call(e);!(o=(n=r.next()).done)&&(a.push(n.value),!t||a.length!==t);o=!0);}catch(e){i=!0,s=e}finally{try{o||null==r.return||r.return()}finally{if(i)throw s}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return d(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?d(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function u(e,t,r){if(r>=e.length)for(var n=r-e.length+1;n--;)e.push(void 0);return e.splice(r,0,e.splice(t,1)[0]),e}function E(e,t){const r=Object.keys(e).filter((t=>t.indexOf("Enabled")>-1&&e[t]));return function(e){if(e.length<2)return e;for(const r of A.TA.entries()){var t=m(r,2);const n=t[0],s=t[1],a=e.indexOf(s);a>-1&&(e=u(e,a,n))}return e}([...new Set(r.map((e=>{let t=0;for(const n of Object.entries(A.mv)){var r=m(n,2);const s=r[0];if(r[1].indexOf(e)>-1){t=s;break}}return t})).filter((e=>e)))])}var b=r(66);const _="op_posts",T="hidden_threads",f="whitelisted_threads",p="thread_cache",h="message_store",S="tags",D=[{id:"12347",isAnimeImage:!0},{id:"12348",isAnimeImage:!1}];let y;function O(e,t){return new Promise((function(r){let n=y.transaction(e,"readwrite").objectStore(e).get(t);n.onsuccess=function(e){return r(n.result)},n.onerror=function(e){return r(n.result)}}))}function x(e,t){return new Promise((function(r){const n=t.id;let s=y.transaction(e,"readwrite"),a=s.objectStore(e).add(t);s.oncomplete=function(t){return(0,b.Z)("Added item into "+e+" DB: "+n),r(a.result)},s.onerror=function(e){console.log(e)}}))}function I(e,t){return new Promise((function(r){(0,b.Z)("Updating multiple items in DB "+e+": "+t.length);let n=y.transaction(e,"readwrite"),s=n.objectStore(e);for(const e of t)s.put(e);let a=0;n.onsuccess=function(e){},n.oncomplete=function(n){(0,b.Z)("Added "+t.length+" items into "+e+" DB"),r(n.target.result)},n.onerror=function(e){a<3&&(console.log(e),a++)}}))}function R(e,t,r,n){let s=y.transaction(e,"readwrite").objectStore(e),a=s.get(t);a.onsuccess=function(e){let t=e.target.result;t[r]=n;let a=s.put(t);a.onsuccess=function(e){},a.onerror=function(e){}},a.onerror=function(e){}}function w(e,t){return new Promise((function(r){const n=t.id;let s=y.transaction(e,"readwrite");s.objectStore(e).delete(n),s.oncomplete=function(t){(0,b.Z)("Removed thread from DB  "+e+": "+n)},s.onerror=function(e){console.log(e),console.log("Thread id removal failed: "+n)}}))}function C(e){return new Promise((function(t){let r=y.transaction(e,"readwrite").objectStore(e).getAll();r.onsuccess=function(e){return t(r.result)},r.onerror=function(e){return t(r.result)}}))}async function P(e){return new Promise((function(t){let r=y.transaction(e,"readwrite").objectStore(e).clear();r.onsuccess=function(n){return console.log(e+" cleared"),t(r.result)},r.onerror=function(e){return t(r.result)}}))}async function N(e){return new Promise((function(t){let r=y.transaction(e,"readonly").objectStore(e).count();r.onsuccess=function(e){return t(r.result)},r.onerror=function(e){return t(r.result)}}))}async function H(e,t,r){return new Promise((function(n){let s=y.transaction(e,"readonly").objectStore(e).index(t).getAll(r);s.onsuccess=function(e){return n(s.result)},s.onerror=function(e){}}))}function M(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function v(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?M(Object(r),!0).forEach((function(t){j(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):M(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function j(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}(async()=>{y=await new Promise((function(e){let t=indexedDB.open("ylilauta_thread_hider",12);t.onupgradeneeded=function(e){((e,t)=>{let r,n,s,a,o,i,c,l=t.target.result;try{e.transaction.objectStore(_)}catch(e){r=l.createObjectStore(_,{keyPath:"id"}),r.transaction.oncomplete=function(e){let t=l.transaction(_,"readwrite").objectStore(_);D.forEach((function(e){t.add(e)}))}}try{e.transaction.objectStore(f)}catch(e){n=l.createObjectStore(f,{keyPath:"id"}),n.transaction.oncomplete=function(e){l.transaction(f,"readwrite").objectStore(f).add({id:12345,created:new Date})}}try{e.transaction.objectStore(T)}catch(e){s=l.createObjectStore(T,{keyPath:"id"}),s.createIndex("created","created",{unique:!1}),s.transaction.oncomplete=function(e){l.transaction(T,"readwrite").objectStore(T).add({id:12345,created:new Date})}}try{e.transaction.objectStore(p)}catch(e){a=l.createObjectStore(p,{keyPath:"threadId"}),a.createIndex("created","created",{unique:!1}),a.createIndex("page","page",{unique:!1}),a.transaction.oncomplete=function(e){let t=l.transaction(p,"readwrite").objectStore(p);t.add({threadId:12345,created:new Date,page:1}),t.add({threadId:12346,created:new Date,page:2})}}try{e.transaction.objectStore(h)}catch(e){o=l.createObjectStore(h,{keyPath:"id"}),o.createIndex("created","created",{unique:!1}),o.createIndex("shown","shown",{unique:!1}),o.transaction.oncomplete=function(e){}}try{e.transaction.objectStore(S)}catch(e){i=l.createObjectStore(S,{keyPath:"tagId"}),i.createIndex("created","created",{unique:!0}),i.transaction.oncomplete=function(e){}}try{c=e.transaction.objectStore(T),c.index("tagId").getAll(null)}catch(t){c=e.transaction.objectStore(T),c.createIndex("tagId","tagId",{unique:!1})}try{c=e.transaction.objectStore(S),c.index("old").getAll(null)}catch(t){c=e.transaction.objectStore(S),c.createIndex("old","old",{unique:!1})}})(t,e)},t.onsuccess=function(t){return e(t.target.result)}}))})();class k{constructor(e,t,r,n){this.id=e,this.priority=n,this.message=r,this.senderTabId=t}}const Z=[{id:2,m:"Tässä linkki googleen <a href='https://www.google.fi'>ddd</a>",p:1}];var F=r(625);const L=async(e,t,r)=>{let n,s={method:null==t?"GET":t,headers:{"Content-Type":"application/json"}};null!=r&&(s.body=JSON.stringify(r));try{n=await fetch(e,s).then((e=>e.json()))}catch(e){console.log(e)}return n},G=(e,t,r)=>Object.assign({},e,{[t]:r}),B=e=>{let t=e;return null==t?t=[]:Array.isArray(t)||(t=[t]),t},U=Object.freeze({GET_SYNC_ID:"http://localhost:8080/api/syncids/new",PAIR_DEVICE:"http://localhost:8080/api/syncids/pair/",POST_UPLOAD:"http://localhost:8080/api/posts",NEW_TAG:"http://localhost:8080/api/tags/new/",POSTS_PER_TAG:"http://localhost:8080/api/posts/tag/",TAGS_RELATED_TO_SYNC_ID:"http://localhost:8080/api/tags/syncid/"});var W=r(625);const V=Object.freeze({SYNC_TAGS_FROM_SERVER:"syncTagsFromServer",SYNC_TAGS_TO_DB:"syncTagsToDb",SYNC_POSTS_FROM_SERVER:"syncPostsFromServer",SET_ALL_TAGS_AS_OLD:"setAllTagsAsOld",FETCH_NEW_TAG_FROM_SERVER:"fetchNewTagFromServer",SYNC_POSTS_TO_SERVER:"syncPostsToServer"}),Y=Object.freeze({DOWNLOAD:"Downloading",UPLOAD:"Uploading",CLEANUP:"Cleanup"}),$=async e=>{await P(S);let t=await L(U.TAGS_RELATED_TO_SYNC_ID+e,"GET");de(Y.DOWNLOAD,"tags","finished",t.length,t.length),re.publish(V.SYNC_TAGS_TO_DB,t)},q=async e=>{let t,r,n=0,s=1,a=!1;for(;n<s;){let o=await L(U.POSTS_PER_TAG+e+"?page="+n,"GET");if(t=o.totalElements,r=o.pageable.pageSize,0==o.totalElements){a=!0;break}if(de(Y.DOWNLOAD,"posts","Tag ID:"+e.substring(0,2)+"****",r*(n+1),t),null!=o.content){const e=B(o.content),t=K(e);await I(T,t)}s=o.totalPages,n+=1}a||de(Y.DOWNLOAD,"posts","Finished",t,t)},z=async()=>{const e=(await W.storage.sync.get("syncId")).syncId,t={id:{syncId:e.id.syncId,deviceId:e.id.deviceId}};let r=await L(U.NEW_TAG,"POST",t);return r.old="1",await x(S,r),r},Q=async(e,t,r)=>{let n,s;if(null==r){if(n=await async function(e,t,r){return new Promise((function(t){let r=y.transaction(e,"readonly").objectStore(e).index("tagId").count("0");r.onsuccess=function(e){return t(r.result)},r.onerror=function(e){return t(r.result)}}))}(T),!B(n).length)return;s=await z()}else n=r,s=e;const a=1e3;let o=null==t?0:t;de(Y.UPLOAD,"posts","Tag ID: "+s.tagId.substring(0,2)+"****",o,n);let i=await function(e,t,r,n,s){return new Promise(((t,r)=>{const s=[],a=y.transaction(e,"readonly");a.oncomplete=e=>t(s),a.onerror=e=>r(e.target);const o=a.objectStore(e).index("tagId").openCursor("0");let i=0===n,c=0;o.onsuccess=e=>{const t=e.target.result;if(t)if(i){if(c++,s.push(t.value),c>=1e3)return;t.continue()}else i=!0,t.advance(n)}}))}(T,0,0,o);await L(U.POST_UPLOAD,"POST",((e,t)=>({tagId:t.tagId,posts:e.map((e=>e.id))}))(i,s)),i.map((e=>G(e,"tagId",s.tagId))),i.length&&await I(T,i),i.length==a&&(o+=a,await Q(s,o,n)),null==t&&de(Y.UPLOAD,"posts","Finished",n,n)},K=e=>e.map((e=>({id:e.id.postId,tagId:e.id.tagId})));var X=r(625);function J(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function ee(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?J(Object(r),!0).forEach((function(t){te(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):J(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function te(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const re=(()=>{const e={};return{publish:function(t,r){Array.isArray(e[t])&&e[t].forEach((e=>{e(r)}))},subscribe:function(t,r){Array.isArray(e[t])||(e[t]=[]),e[t].push(r)}}})();let ne={},se=null,ae=[],oe=null,ie=null;const ce=()=>ie;async function le(e){return new Promise((t=>setTimeout(t,e)))}function ge(e,t){X.tabs.sendMessage(e,t)}re.subscribe(a.Z.ATTACH_MANIFEST,(function e(t){null!=oe?(t=ee(ee({},t),{},{manifest:[...oe]}),re.publish(a.Z.CHECK_IF_THREAD_HAS_BEEN_HIDDEN,t)):setTimeout((()=>e(t)),2e3)})),re.subscribe(a.Z.GENERATE_MANIFEST,E),re.subscribe(a.Z.NEXT_STEP,(function(e){let t=e.manifest;if(t.length){const r=t.shift();e.manifest=[...t],re.publish(r,e)}})),re.subscribe(a.Z.REPORT_FAILED_THREAD,(function(e){e.reason!=c&&(re.publish(a.Z.ADD_TO_HIDE_DB,e),re.publish(a.Z.REMOVE_FROM_WHITELIST_DB,e)),ge(e.senderTabId,{type:i.FAILED_THREAD,payload:e})})),re.subscribe(a.Z.REPORT_WHITELISTED_THREAD,(function(e){ge(e.senderTabId,{type:i.WHITELISTED_THREAD,payload:e})})),re.subscribe(a.Z.REPORT_IMAGE_SCAN,(function(e){ge(e.senderTabId,{type:i.IMAGE_SCAN_START,payload:{threadId:e.threadId}})})),re.subscribe(a.Z.REPORT_IMAGE_SCAN_OVER,(function(e){ge(e.senderTabId,{type:i.IMAGE_SCAN_OVER})})),re.subscribe(a.Z.REPORT_IMAGE_SCAN_FINISHED,(function(e){ge(e.senderTabId,{type:i.IMAGE_SCAN_FINISHED,payload:{threadId:e.threadId,passed:!e.isAnimeImage}})})),re.subscribe(a.Z.PUSH_TO_FETCH_QUEUE,(function(e){void 0!==ae&&(ae.push(e),async function(){for(;ae.length;){const e=ae.shift(),t=e.masterTabId,r="https://ylilauta.org/satunnainen-"+e.page+"/";if(null!=se){const e=(new Date).getTime()-se.getTime();e<5e3&&await le(5e3-e)}se=new Date;let n=ne[t];if(Array.isArray(n)&&t.length)return;const s=await X.tabs.create({url:r,active:!1});null==ne[t]?ne[t]=[s.id]:ne[t].push(s.id)}}())})),re.subscribe(a.Z.REFRESH_CACHE,(async function(e){re.publish(a.Z.PUSH_TO_FETCH_QUEUE,e)})),re.subscribe(a.Z.SEND_TO_MASTER_TAB,(function(e){ge(e.masterTabId,{type:i.THREAD_FROM_OTHER_PAGE,payload:e})})),re.subscribe(a.Z.RETURN_UNREAD_MESSAGES,(function(e){ge(e.senderTabId,{type:i.UNREAD_MESSAGE,payload:e})})),re.subscribe(a.Z.IMAGE_PROCESSOR,(async function(e){const t=e.threadId,r=e.imageUrl;(0,b.Z)("Entering imageProcessor, in indexedDB:"+t),void 0===await O(_,t)&&null!==r?((0,b.Z)("Sending to imageProcessor as no match in DB: "+t),re.publish(a.Z.OPENCV,e)):(0,b.Z)("Exiting imageProcessor, thread already matched in DB:"+t)})),re.subscribe(a.Z.ADD_TO_ANIME_IMAGE_THREAD_DB,(function(e){return x(_,{id:e.threadId,isAnimeImage:e.isAnimeImage})})),re.subscribe(a.Z.CHECK_IF_THREAD_HAS_BEEN_HIDDEN,(async function(e){const t=e.threadId,r=e.message,s=e.senderTabId;if((0,b.Z)("Checking if thread is already hidden, in indexedDB:"+t),null!=await O(f,t))return(0,b.Z)("Thread is whitelisted: "+t),void re.publish(a.Z.REPORT_WHITELISTED_THREAD,new n.Z(t,r,l,s));null!=await O(T,t)?(re.publish(a.Z.REPORT_FAILED_THREAD,new n.Z(t,r,c,s)),(0,b.Z)("Exiting preliminary check, thread already matched in DB:"+e.threadId)):((0,b.Z)("Thread not found in hideDB: "+t),re.publish(a.Z.NEXT_STEP,e))})),re.subscribe(a.Z.ADD_TO_HIDE_DB,(async function(e){const t=e.id;return await x(T,{id:t,created:new Date,tagId:"0"})})),re.subscribe(a.Z.REMOVE_FROM_HIDE_DB,(function(e){const t=e.id;return re.publish(a.Z.ADD_TO_WHITELIST_DB,e),w(T,{id:t})})),re.subscribe(a.Z.ADD_TO_WHITELIST_DB,(function(e){const t=e.id;return x(f,{id:t})})),re.subscribe(a.Z.REMOVE_FROM_WHITELIST_DB,(function(e){const t=e.id;return w(f,{id:t})})),re.subscribe(a.Z.FETCH_CACHED_THREADS,(async function(e){const t=e.page,r=e.masterTabId;let n=await H(p,"page",t.toString());if(n.length){const e=n[0].created;if((new Date).getTime()-e.getTime()<12e5){console.log("returning cache");for(let e of n)e.masterTabId=r,e.senderTabId=r,re.publish(a.Z.SEND_TO_MASTER_TAB,e),re.publish(a.Z.ATTACH_MANIFEST,e);return}await P(p)}(0,b.Z)("refreshing cache"),re.publish(a.Z.REFRESH_CACHE,e)})),re.subscribe(a.Z.ADD_THREAD_TO_CACHE,(function(e){return x(p,v(v({},e),{},{created:new Date}))})),re.subscribe(a.Z.REQUEST_UNREAD_MESSAGES,(async function(e){const t=e.masterTabId,r=e.showOnlyHighPriorityMessages;let n=await C(h);console.error(n),n=n.filter((e=>!e.shown)),r&&(n=n.filter((e=>1==e.priority)));for(const e of n)re.publish(a.Z.RETURN_UNREAD_MESSAGES,new k(e.id,t,e.message,e.priority))})),re.subscribe(a.Z.MARK_MESSAGE_AS_READ,(function(e){R(h,e,"shown",!0)})),re.subscribe(a.Z.CLEAR_STORE,(async function(e){await P(e)})),re.subscribe(a.Z.ADD_TAG_TO_DB,(async function(e){console.log(await N(S)),console.log(await N(T)),console.log(await C(S)),await x(S,e)})),re.subscribe(V.SYNC_TAGS_FROM_SERVER,$),re.subscribe(V.SYNC_TAGS_TO_DB,(async e=>{const t=await C(S);let r=[];t.length>0&&(r=t.filter((e=>"1"==e.old)).map((e=>e.tagId)));const n=e.filter((e=>-1==r.indexOf(e.tagId))).map((e=>G(e,"old","0")));n.length&&await I(S,n),re.publish(V.SYNC_POSTS_FROM_SERVER,n)})),re.subscribe(V.SYNC_POSTS_FROM_SERVER,(async e=>{for(const t of e)de(Y.DOWNLOAD,"posts","Tag ID:"+t.tagId.substring(0,2)+"****"),await q(t.tagId);re.publish(V.SET_ALL_TAGS_AS_OLD)})),re.subscribe(V.SET_ALL_TAGS_AS_OLD,(async()=>{de(Y.CLEANUP,"tags","Cleaning up database");let e=await H(S,"old","0");e=B(e);const t=e.map((e=>G(e,"old","1")));t.length&&await I(S,t),de(Y.CLEANUP,"tags","Cleanup finished"),re.publish(V.SYNC_POSTS_TO_SERVER)})),re.subscribe(V.FETCH_NEW_TAG_FROM_SERVER,z),re.subscribe(V.SYNC_POSTS_TO_SERVER,Q),X.runtime.onMessage.addListener((async(e,t,r)=>{const c=e.type,l=e.payload;switch(c){case o.INIT:ie=(0,g.D)(l,ie),ge(t.tab.id,{type:i.INIT_COMPLETE}),oe=E(ie);break;case o.AM_I_SPAWNED:const r=function(e,t){for(const r of Object.keys(t)){if(r==e)return null;if(t[r].indexOf(e)>-1)return r}return null}(t.tab.id,ne);ge(t.tab.id,{type:null!=r?i.YOU_A_SPAWN_BRO:i.NAH_YOU_LEGIT_BRO,payload:{masterTabId:r}}),null==r&&re.publish(a.Z.GENERATE_MANIFEST,ie);break;case o.ASK_FOR_MESSAGES:re.publish(a.Z.REQUEST_UNREAD_MESSAGES,{masterTabId:t.tab.id,showOnlyHighPriorityMessages:ie.showOnlyHighPriorityMessages});break;case o.MARK_MESSAGE_AS_READ:re.publish(a.Z.MARK_MESSAGE_AS_READ,l);break;case o.SEND_THREADS_TO_ANOTHER_TAB:(function(e,t){F.tabs.remove(e).then((r=>{console.log("Closed tab id:"+e),function(e,t){for(const r of Object.keys(t)){const n=t[r].indexOf(e);if(n>-1){t[r].splice(n,1);break}}}(e,t)}))})(t.tab.id,ne),l.threads.map((e=>{re.publish(a.Z.SEND_TO_MASTER_TAB,e),re.publish(a.Z.ADD_THREAD_TO_CACHE,ee(ee({},e),{},{page:l.page})),re.publish(a.Z.ATTACH_MANIFEST,ee(ee({},e),{},{senderTabId:e.masterTabId}))}));break;case o.THREADS:l.map((e=>{e.senderTabId=t.tab.id,re.publish(a.Z.ATTACH_MANIFEST,e)}));break;case o.HIDE_THREAD:re.publish(a.Z.REPORT_FAILED_THREAD,new n.Z(l,"","Hidden manually by user",t.tab.id));break;case o.UNHIDE_THREAD:re.publish(a.Z.REMOVE_FROM_HIDE_DB,new n.Z(l,"","Unhidden manually by user",t.tab.id));break;case o.REQUEST_CACHED_THREADS:re.publish(a.Z.FETCH_CACHED_THREADS,new s(t.tab.id,l.latestPage.toString()));break;case o.CLEAR_STORE:re.publish(a.Z.CLEAR_STORE,l.store);break;case o.ADD_TAG:re.publish(a.Z.ADD_TAG_TO_DB,l);break;case o.ACQUIRE_SYNC_ID:Ae();break;case o.PAIR_DEVICE:me(l);break;case o.START_SYNC:$(l);break;case o.RESET_DB:await(async()=>{await async function(e,t){const r=e.map((e=>({id:e.id,created:new Date,tagId:"0"})));return t?await I(T,r):await function(e,t){return new Promise((function(r){(0,b.Z)("Adding multiple items in DB "+e+": "+t.length);let n=y.transaction(e,"readwrite"),s=n.objectStore(e),a=0;for(const e of t)0==a&&(console.log(e),a++),s.add(e);let o=0;n.onsuccess=function(e){},n.oncomplete=function(n){(0,b.Z)("Added "+t.length+" items into "+e+" DB"),r(n.target.result)},n.onerror=function(e){o<3&&(console.log(e),o++)}}))}(T,r)}([...Array(3e3).keys()].map((e=>({id:Math.round(1e9*Math.random()).toString()}))),!0);const e=await N(T);console.log("new count: "+e)})();break;default:console.error("main.js - message type unknown"),console.error(e)}return!0}));const Ae=async()=>{const e=await L(U.GET_SYNC_ID);X.runtime.sendMessage({type:i.NEW_SYNC_ID,payload:e})},me=async e=>{const t=await L(U.PAIR_DEVICE+e);X.runtime.sendMessage({type:i.PAIR_RESULT,payload:t})},de=(e,t,r,n,s)=>{X.runtime.sendMessage({type:i.SYNC_LOG,payload:{operation:e,type:t,message:r,current:n,total:s}})};setTimeout((()=>{!async function(){Z.map((async(e,t)=>{const r={id:e.id,created:new Date,message:e.m+"s",shown:!1,priority:e.p};console.log(r),await R(h,e.id,"shown",!1)}))}()}),500)},287:(e,t,r)=>{"use strict";var n=r(63),s=r(559),a=r(66),o=r(751),i=r(167);i.RV.subscribe("textProcessor",(function(e){const t=e.threadId,r=e.message,c=e.imageUrl,l=e.manifest,g=e.senderTabId,A=(e.subject,e.downvoteCount),m=e.postDeleted;(0,a.Z)("In textProcessor: "+t);let d=r.replace(/<\/?[^>]+(>|$)/g,"").replaceAll("&gt;",">").replaceAll("&lt;","<"),u=null;if((0,o.m)("pollThreadsEnabled")&&e.hasPoll)u="Contains poll";else if((0,o.m)("allCapsEnabled")&&!/[a-z]/.test(d)&&/[A-Z]/.test(d))u="Thread was in all caps";else if((0,o.m)("noCapsEnabled")&&/[a-z]/.test(d)&&!/[A-Z]/.test(d))u="Thread had no caps";else if((0,o.m)("wordCountEnabled")&&d.split(" ").filter((e=>e.length>(0,o.m)("wordLength"))).length<((0,o.m)("wordCount")||3))u="Thread OP had <"+(0,o.m)("wordCount")+" words with < "+(0,o.m)("wordLength")+" characters long";else if((0,o.m)("emojisEnabled")&&/\p{Extended_Pictographic}/u.test(d))u="Thread contained emojis";else if((0,o.m)("noImageEnabled")&&null==c)u="Thread has no image";else if((0,o.m)("downvoteEnabled")&&A>=(0,o.m)("downvoteCount"))u="Thread had "+A+" downvotes and the maximum allowed downvotes is less than"+(0,o.m)("downvoteCount");else if(o.m.onlyGreenTextEnabled&&0==d.split("\n").filter((e=>!e.startsWith(">")&&e.length>5)).length)u="Thread contained only greentext and one or less line";else if((0,o.m)("deletedEnabled")&&m)u="OP post had already been deleted";else for(let e of(0,i.P_)().blacklistedWords)try{if(r.split(" ").length<80&&e.match(/^\/.+\/$/)&&r.toLowerCase().match(new RegExp(e.substring(1,e.length-1)))){u="Contains blacklisted regex term: "+e;break}if(r.toLowerCase().indexOf(e.toLowerCase())>-1){u="Contains blacklisted word: "+e;break}}catch(t){console.error(t),console.error(e),console.log(r)}null!=u?(i.RV.publish(s.Z.REPORT_FAILED_THREAD,new n.Z(t,r,u,g)),(0,a.Z)("Failed in textProcessor: "+t)):((0,a.Z)("Passed textProcessor, moving to "+l[0]+": "+t),i.RV.publish(s.Z.NEXT_STEP,e))}))},63:(e,t,r)=>{"use strict";r.d(t,{Z:()=>n});class n{constructor(e,t,r,n){this.id=e,this.message=t,this.reason=r,this.senderTabId=n}}},559:(e,t,r)=>{"use strict";r.d(t,{Z:()=>s});const n=Object.freeze({GENERATE_MANIFEST:"generateManifest",IMAGE_PROCESSOR:"imageProcessor",ATTACH_MANIFEST:"attachManifest",TEXT_PROCESSOR:"textProcessor",REPORT_FAILED_THREAD:"reportFailedThread",REPORT_WHITELISTED_THREAD:"reportWhitelistedThread",NEXT_STEP:"nextStep",ADD_TO_ANIME_IMAGE_THREAD_DB:"addThreadToDb",CHECK_IF_THREAD_HAS_BEEN_HIDDEN:"checkIfThreadHasBeenHidden",OPENCV:"openCV",REPORT_IMAGE_SCAN:"reportImageScan",REPORT_IMAGE_SCAN_FINISHED:"reportImageScanFinished",REPORT_IMAGE_SCAN_OVER:"reportImageScanOver",PUSH_TO_FETCH_QUEUE:"pushToFetchQueue",ADD_TO_HIDE_DB:"addToHideDb",ADD_TO_WHITELIST_DB:"addToWhitelistDb",REMOVE_FROM_HIDE_DB:"removeFromHideDb",REMOVE_FROM_WHITELIST_DB:"removeFromWhitelistDb",HIDE_THREAD:"hideThread",WHITELIST_THREAD:"whitelistThread",FETCH_CACHED_THREADS:"fetchCachedThreads",REFRESH_CACHE:"refreshCache",ADD_THREAD_TO_CACHE:"addThreadToCache",SEND_TO_MASTER_TAB:"sendToMasterTab",REQUEST_UNREAD_MESSAGES:"requestUnreadMessages",RETURN_UNREAD_MESSAGES:"returnUnreadMessages",SHOW_UNREAD_MESSAGE:"showUnreadMessage",CREATE_MESSAGE_MODAL:"createMessageModal",MARK_MESSAGE_AS_READ:"markMessageAsRead",CLEAR_STORE:"clearStore",ADD_TAG_TO_DB:"addTagToDb"}),s=(Object.freeze({ADD_TAG:"addTag"}),n)},415:(e,t,r)=>{"use strict";r.d(t,{u8:()=>n,mv:()=>a,TA:()=>o});const n=["shitposts","perverts","junkies","parasites","pastas","politics","sports","internetCelebs","custom"],s=n.map((e=>e+"Enabled")),a=Object.freeze({textProcessor:["onlyGreenText","allCapsEnabled","hasNameEnabled","topicPosterEnabled","noCapsEnabled","onlyGreenTextEnabled","emojisEnabled","wordCountEnabled","noImageEnabled"].concat(s),imageProcessor:["animeImageEnabled"]}),o=Object.freeze(["textProcessor","imageProcessor"])},751:(e,t,r)=>{"use strict";r.d(t,{m:()=>a,D:()=>o});var n=r(167),s=r(415);function a(e){let t=(0,n.P_)();return null!==t&&t[e]}function o(e,t){if(e!==Object(e)||!Object.keys(e).length)return console.error("Configuration failed"),null;t=e;let r=[];return s.u8.map((t=>{if(e[t+"Enabled"]){const n=e[t];Array.isArray(n)&&(r=r.concat(e[t]))}})),Object.keys(e).map((t=>{e.hasOwnProperty(t+"Enabled")&&Array.isArray(e[t])&&!e[t+"Enabled"]&&(delete e[t],delete e[t+"Enabled"])})),t.blacklistedWords=r,console.log("Configuration completed"),t}},66:(e,t,r)=>{"use strict";r.d(t,{Z:()=>n});const n=e=>{}},625:function(e,t,r){var n,s,a=r(625);"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self&&self,void 0===(s="function"==typeof(n=function(e){"use strict";if(void 0===window.browser||Object.getPrototypeOf(window.browser)!==Object.prototype||Object.getPrototypeOf(a)!==Object.prototype){const t="The message port closed before a response was received.",r="Returning a Promise is the preferred way to send a reply from an onMessage/onMessageExternal listener, as the sendResponse will be removed from the specs (See https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage)",n=e=>{const n={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(0===Object.keys(n).length)throw new Error("api-metadata.json has not been included in browser-polyfill");class s extends WeakMap{constructor(e,t){super(t),this.createItem=e}get(e){return this.has(e)||this.set(e,this.createItem(e)),super.get(e)}}const a=(t,r)=>(...n)=>{e.runtime.lastError?t.reject(new Error(e.runtime.lastError.message)):r.singleCallbackArg||n.length<=1&&!1!==r.singleCallbackArg?t.resolve(n[0]):t.resolve(n)},o=e=>1==e?"argument":"arguments",i=(e,t,r)=>new Proxy(t,{apply:(t,n,s)=>r.call(n,e,...s)});let c=Function.call.bind(Object.prototype.hasOwnProperty);const l=(e,t={},r={})=>{let n=Object.create(null),s={has:(t,r)=>r in e||r in n,get(s,g,A){if(g in n)return n[g];if(!(g in e))return;let m=e[g];if("function"==typeof m)if("function"==typeof t[g])m=i(e,e[g],t[g]);else if(c(r,g)){let t=((e,t)=>function(r,...n){if(n.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${o(t.minArgs)} for ${e}(), got ${n.length}`);if(n.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${o(t.maxArgs)} for ${e}(), got ${n.length}`);return new Promise(((s,o)=>{if(t.fallbackToNoCallback)try{r[e](...n,a({resolve:s,reject:o},t))}catch(a){console.warn(`${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,a),r[e](...n),t.fallbackToNoCallback=!1,t.noCallback=!0,s()}else t.noCallback?(r[e](...n),s()):r[e](...n,a({resolve:s,reject:o},t))}))})(g,r[g]);m=i(e,e[g],t)}else m=m.bind(e);else if("object"==typeof m&&null!==m&&(c(t,g)||c(r,g)))m=l(m,t[g],r[g]);else{if(!c(r,"*"))return Object.defineProperty(n,g,{configurable:!0,enumerable:!0,get:()=>e[g],set(t){e[g]=t}}),m;m=l(m,t[g],r["*"])}return n[g]=m,m},set:(t,r,s,a)=>(r in n?n[r]=s:e[r]=s,!0),defineProperty:(e,t,r)=>Reflect.defineProperty(n,t,r),deleteProperty:(e,t)=>Reflect.deleteProperty(n,t)},g=Object.create(e);return new Proxy(g,s)},g=e=>({addListener(t,r,...n){t.addListener(e.get(r),...n)},hasListener:(t,r)=>t.hasListener(e.get(r)),removeListener(t,r){t.removeListener(e.get(r))}}),A=new s((e=>"function"!=typeof e?e:function(t){const r=l(t,{},{getContent:{minArgs:0,maxArgs:0}});e(r)}));let m=!1;const d=new s((e=>"function"!=typeof e?e:function(t,n,s){let a,o,i=!1,c=new Promise((e=>{a=function(t){m||(console.warn(r,(new Error).stack),m=!0),i=!0,e(t)}}));try{o=e(t,n,a)}catch(e){o=Promise.reject(e)}const l=!0!==o&&((g=o)&&"object"==typeof g&&"function"==typeof g.then);var g;if(!0!==o&&!l&&!i)return!1;return(l?o:c).then((e=>{s(e)}),(e=>{let t;t=e&&(e instanceof Error||"string"==typeof e.message)?e.message:"An unexpected error occurred",s({__mozWebExtensionPolyfillReject__:!0,message:t})})).catch((e=>{console.error("Failed to send onMessage rejected reply",e)})),!0})),u=({reject:r,resolve:n},s)=>{e.runtime.lastError?e.runtime.lastError.message===t?n():r(new Error(e.runtime.lastError.message)):s&&s.__mozWebExtensionPolyfillReject__?r(new Error(s.message)):n(s)},E=(e,t,r,...n)=>{if(n.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${o(t.minArgs)} for ${e}(), got ${n.length}`);if(n.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${o(t.maxArgs)} for ${e}(), got ${n.length}`);return new Promise(((e,t)=>{const s=u.bind(null,{resolve:e,reject:t});n.push(s),r.sendMessage(...n)}))},b={devtools:{network:{onRequestFinished:g(A)}},runtime:{onMessage:g(d),onMessageExternal:g(d),sendMessage:E.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:E.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},_={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return n.privacy={network:{"*":_},services:{"*":_},websites:{"*":_}},l(e,b,n)};if("object"!=typeof chrome||!chrome||!chrome.runtime||!chrome.runtime.id)throw new Error("This script should only be loaded in a browser extension.");e.exports=n(chrome)}else e.exports=a})?n.apply(t,[e]):n)||(e.exports=s)}},t={};function r(n){var s=t[n];if(void 0!==s)return s.exports;var a=t[n]={exports:{}};return e[n].call(a.exports,a,a.exports,r),a.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r(167),r(287)})();